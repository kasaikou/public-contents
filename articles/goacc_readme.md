---
title: Goの構造体にアクセサーを作るためのコードジェネレーターを作ってみた
emoji: 😇
type: tech
topics: [go, golang, go言語, コードジェネレーター]
published: false
---

## この記事は何の記事？

[goacc](https://github.com/kasaikou/goacc)と言うツールを作ったのでその日本語版READMEです。最初から英語のREADMEを書くのはとても疲れてしまうので、一度日本語で書く内容を整理してから書こうと思った、と言うだけでの記事です。


Go にアクセサーをつける系のコードジェネレーターの時点でGoらしくない開発な上にN番煎じ感が否めないですが、少々お付き合いいただければと思います。

# Abstract

Go にアクセサーなどなど色々なものをつけるコードジェネレーターを作りました。

https://github.com/kasaikou/goacc

現時点で以下のような機能を作りました。

- 構造体のタグによる設定管理
- ビルダーパターン `XxxBuilder` を自動作成し、Go構造体の初期化機能
  - `goaccPreNewHook()`, `goaccPostNewHook()` でのフック関数の呼び出し
- アクセサーの自動作成
- `MarshalJSON` の自動作成

# Install

`go install` してください。

```sh
go install github.com/kasaikou/goacc@latest
```

# Usage

## Simple Usage

以下のようなGoファイル `models/sample.go` を作成します。

```go
package models

type Sample struct {
	name string `goacc:"required,get,json"`
	piyo int    `goacc:"optional,get,json(,omitempty)"`
	hoge string `goacc:"optional,get,set"`
}
```

このファイルが対象となるように `goacc` コマンドを実行します。

```sh
goacc -i "models/**/*.go"
```

すると `models/sample_goacc.go` ファイルが作成されます。
あまりに長いので要点だけまとめると以下のようなコードが生成されます。

```go
// Code generated by github.com/kasaikou/goacc, DO NOT EDIT.

// NewSampleBuilder は SampleBuilder を作成する
func NewSampleBuilder(name string) SampleBuilder { /*...*/ }

// SampleBuilder は Sample 構造体を作成するためのビルダー
type SampleBuilder interface {
	SetPiyo(piyo int) SampleBuilder     // Piyo を設定する
	SetHoge(hoge string) SampleBuilder  // Hoge を設定する
	Build() *Sample                     // Sample 構造体のインスタンスを作成する
}

// Sample 構造体のアクセサー

func (__s *Sample) Name() string { /*...*/ }

func (__s *Sample) Piyo() int { /*...*/ }

func (__s *Sample) Hoge() string { /*...*/ }

func (__s *Sample) SetHoge(hoge string) { /*...*/ }

func (__s *Sample) MarshalJSON() ([]byte, error) { /*...*/ }
```

:::details `models/sample_goacc.go` コード全文

```go
// Code generated by github.com/kasaikou/goacc, DO NOT EDIT.
// defaultTag=-
package tests

import "encoding/json"

type SampleBuilder interface {
	SetPiyo(piyo int) SampleBuilder
	SetHoge(hoge string) SampleBuilder
	Build() *Sample
}

// sampleBuilderImpl is an instance for generating an instance of Sample.
type sampleBuilderImpl struct {
	__s *Sample
}

// NewSampleBuilder creates an SampleBuilder instance.
func NewSampleBuilder(
	name string,
) SampleBuilder {
	__s := &Sample{}

	__s.name = name

	return &sampleBuilderImpl{__s: __s}
}

func (__sb *sampleBuilderImpl) SetPiyo(piyo int) SampleBuilder {
	if __sb == nil {
		panic("sampleBuilderImpl is nil")
	} else if __sb.__s != nil {
		__sb.__s.piyo = piyo
		return __sb
	}

	panic("Sample has been already purged")
}

func (__sb *sampleBuilderImpl) SetHoge(hoge string) SampleBuilder {
	if __sb == nil {
		panic("sampleBuilderImpl is nil")
	} else if __sb.__s != nil {
		__sb.__s.hoge = hoge
		return __sb
	}

	panic("Sample has been already purged")
}

// Build purges Sample instance from sampleBuilderImpl.
//
// If calls other method in sampleBuilderImpl after Purge called, it will be panic.
func (__sb *sampleBuilderImpl) Build() *Sample {
	if __sb == nil {
		panic("sampleBuilderImpl is nil")
	} else if __sb.__s != nil {
		__s := __sb.__s
		__sb.__s = nil

		return __s
	}

	panic("Sample has been already purged")
}

func (__s *Sample) Name() string {
	if __s != nil {
		return __s.name
	}

	panic("Sample is nil")
}

func (__s *Sample) Piyo() int {
	if __s != nil {
		return __s.piyo
	}

	panic("Sample is nil")
}

func (__s *Sample) Hoge() string {
	if __s != nil {
		return __s.hoge
	}

	panic("Sample is nil")
}

func (__s *Sample) SetHoge(hoge string) {
	if __s != nil {
		__s.hoge = hoge
	}
}

func (__s *Sample) MarshalJSON() ([]byte, error) {

	type SampleJSONContent struct {
		Name string `json:"name"`
		Piyo int    `json:"piyo,omitempty"`
	}

	return json.Marshal(SampleJSONContent{
		Name: __s.name,
		Piyo: __s.piyo,
	})
}
```

:::

## Struct tags

`goacc` では構造体のタグを見て何を実装するかを選択します。

```go
type Sample struct {
	name string `goacc:"required,get,json"`
	piyo int    `goacc:"optional,get,json(,omitempty)"`
	hoge string `goacc:"optional,get,set"`
}
```

タグ名はカンマ区切りで読まれていきます。

| タグ名 | どういうことをするのか
| :--: | :---
| required | 設定が必要なメンバー変数として `NewXxxBuilder` 呼び出し時の引数になります。
| optional | 設定が可能なメンバー変数として `(*XxxBuilder).SetHoge` と言う形でメソッドチェイン用の関数を作成します。
| get | 読み取りアクセサーを作成します。
| getptr | ポインターとして読み取りアクセサーを作成します（メンバー関数の呼び出しなどのために用意しています）。
| set | 書き込みアクセサーを作成します。
| json(xxx) | `MarshalJSON` 作成時にフィールドとして追加します。括弧内の文字列は `encoding/json` で用いる `json` タグとして渡されます。

## Builder Generation

`goacc` では `required`, `optional` が設定された構造体 `Xxx` に対して `XxxBuilder`（インターフェイス）とそのインスタンスを作成するための `NewXxxBuilder` 関数を定義します。

```go
func NewSampleBuilder(name string) SampleBuilder { /*...*/ }

type SampleBuilder interface {
	SetPiyo(piyo int) SampleBuilder     // Piyo を設定する
	SetHoge(hoge string) SampleBuilder  // Hoge を設定する
	Build() *Sample                     // Sample 構造体のインスタンスを作成する
}
```

`required` で設定されたフィールドはBuilderを初期化する際の `NewXxxBuilder` 関数の引数となります。

それに対して、 `optional` で設定されたフィールドは `XxxBuilder` インターフェイス内で `SetOptional` という形でメソッドが定義されます。

### Hook methods

また、Builderには以下のようなフック関数が定義されています。

| 関数定義 | 呼び出される場所 | 想定用途
| :--- | :--- | :---
| `goaccPreBuildHook()` | required のフィールドが設定される前（構造体が初期化された状態） | フィールドの初期化など
| `goaccPostBuildHook()` | `(XxxBuilder).Build()` 内の `return` 直前 | フィールドを埋める、バリデーションで `panic()` を発生させるなど
| `goaccPostBuildHook() error` | (XxxBuilder).Build()` 内の `return` 直前 | バリデーションなど



## Accessor Generation

### `get`

### `getptr`

### `set`

## `MarshalJSON` Generation

# Motivation

# おわりに

まだ実装していない機能は色々あり、元々ドメインモデルで使用することを前提に置いていたので、型パラメータへの対応や排他処理などできていないことが多いです。あと個人的にはrange-over-func対応も行っていきたいです。

まだ個人的に使うための最低限の機能しか作っていないのでもう少し機能追加を行っていきます。

興味ある人は使ってみてください。
