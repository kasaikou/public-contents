---
title: 未知のサービスに対するTerraform初心者アプローチ
emoji: 🛵
type: tech
topics: [terraform, AWS]
published: false
---

# 私を含めた最初からTerraformを使おうとして挫折した方々，いかがお過ごしでしょうか
この記事では，Terraformで未知のリソースを定義しようと思ったときに私がしていることを紹介しています．読者対象としては「Terraformを導入したはいいけれど，リソースの定義方法がわからないまま挫折して自然消滅させた方」を対象としています．まあ，Terraformの公式ドキュメントを読んでわかる人は直接の対象ではありませんが，「こういう人もいるんだな」くらいで見ていただければ幸いです．

口を大にして言いますが，この記事の合言葉は **「公式ドキュメントを読んでわかるならそれに越したことはない」** です．そのうえで，公式ドキュメントを読んでわからなかった人が，Terraformを利用するるための足がかりをこの記事ではECS on Fargateのサービス作成とS3バケットの作成を例に挙げながら提案していきます．

Repeat after me, **「公式ドキュメントを読んでわかるならそれに越したことはない」**

# TL;DR
- 最初からTerraformを使うだなんて，そんな無理をする必要はないんだよ
    - 一度マネジメントコンソールでリソースを作ったらいいんだよ
- `terraform import` を用いることで，すでにあるリソースを取り込むことができるよ
- `terraform plan` を用いることで，リソースの状態と `.tf` ファイルで定義している内容を比較することができるよ
    - 差がなくなるように調整することでリソースを再現することができるね
- この方法によって作成されるリソースは完全に再現しているとは言えないよ
    - Terraform で定義したファイルからリソースを作成して，ちゃんとチェックする必要があるね

# 最初からTerraformを使うだなんて，そんな無理をする必要はないんだよ
TL;DRでも基本方針は示しましたが，改めて，今回の方法について全体像を確認します．

---
基本的に， **公式ドキュメントを読んでわかるならそれに越したことはない** です．Terraform の公式ドキュメントはサンプル付きで比較的読みやすいドキュメントであるため，それをそのまま利用したとしても，かなり期待に添えたものをつくることができるでしょう．しかし，そのインフラリソースに対する知識が必要なものや，複数のリソースを作成しなければいけないものなど，一筋縄ではいかないものもかなりあります．これらを何も知らない状態からTerraformだけで定義するのは至難の業です．そこで，最初からTerraformを使わずに一度マネジメントコンソールでリソースを作成します．その後， `terraform import` でリソースをTerraformプロジェクトに取り込み，`terraform plan` で差分を比較しながらプロジェクトを編集していくのです．

一度，マネジメントコンソールでプロジェクトにリソースを定義することで複雑なリソースをテンプレート的に起動させ， `terraform import` を用いてTerraformプロジェクトにリソースを取り込むことで，マネジメントコンソールで作製した場合のリソースをTerraformに取り込むことができます．これを `terraform plan` することで，定義されたリソースと現在のリソースとの差分を得られるので，この差分がなくなるように修正していきます．

## 一度マネジメントコンソールでリソースを作る

はじめに，ECSを作成します．とりあえず作ってみましょう．今回は `httpd:2.4` をFargateで動かすことにします．

## `terraform import` & `terraform plan`

次に，先ほど作ったリソースをTerraformにインポートしましょう．既存のプロジェクトがある場合には影響を受けないように独立したプロジェクトとして作ることをお勧めします．
インポート先となるTerraformリソースを作らないとインポートできないので，形だけ作ります．

```terraform
```

続いて，`terraform plan` で変更差分を観察します．

```txt
```

色々な変更が出力されました．これを基に変更差分がなくなるようなリソースを書いていきます．この時に，マネージメントコンソールでの表現とTerraformのドキュメントと照らし合わせることで，Terraformドキュメントを効率よく読み進められます．この記事ではTerraformリソースで再現することを焦点に当てていますが．次の段階としてTerraformからリソースを修正していく際に直感的に変更を加えやすくなるのです．

```terraform
```

もう一度 `terraform plan` で変更差分を観察します．

```txt
```

とりあえず，変更差分がなくなりましたが，ARNが表にあるのはどうにも気に入りません．どうやら，他に依存しているリソースがある様です．この依存しているリソースもAWSが提供しているものでない限りは積極的に取り込んでしまいましょう．また，AWSが提供しているものであっても `Data Source` として取り込むことができます．これを繰り返してできた Terraform のコードが以下になります．

```terraform
```


もう一度 `terraform plan` で変更差分を観察します．
これで，変更差分がなくなり，依存する外部のリソースもおそらく大半のものは回収でき，回収できないものも `Data Source` として取り込むことができました．つまり，先ほどマネージメントコンソールで作成したリソースがTerraformのリソースとして表現を行ったのです．

## 余談: AWSのタグには何を入れるか

Terraformのリソースを管理する目的は色々あると思いますが，その中の一つに「リソースタグをつけたり，機械的な作業を自動化したい」という目的があると思われます．その際にどのようなタグを付けるべきか，という議論をちょくちょく見かけるので，私の一意見として書いておきます．これは私の個人的に使用しているAWSアカウントに対して適用しているものです．

| タグ名 | どのようなものか | 値の一例 |
| :-: | :-- | :-- |
| `ProjectName` | どのような目的で作成したものかを記録 | 任意のプロジェクト名（プロダクト名）
| `ManagedBy` | どのような管理方法を行っているかを記録（設定されていない場合は手作業で作成したものとみなす） | `Terraform`, `CloudFormation` など
| `RepositoryURL` | これを管理しているリポジトリURLを記録 | `github.com/example/repository` など

TerraformでAWSタグを設定する方法には，プロバイダに `shared_tags` を設定する方法と，リソースごとに `tags` を設定する方法の2種類が考えられます．今現在，私は辞書型の変数をTerraformに設置して各リソースごとにAWSタグを設定する方法をとっています．

```terraform
```

この辺は，それぞれいろいろな考え方があるので私一個人で「これが絶対いいです」とは言えないんですが，以下のように比較的簡単にmergeすることができ，モジュールごとに分割したあたりから，修正を加えやすく管理しやすい状態にできるのが今のスタイルのメリットだと思っています．

# この方法は完ぺきではない

さて，ここまで比較的簡単な方法でTerraformプロジェクトに落とし込むことを行いましたが，次にこの方法の良くない点についてです．以下のS3バケットの作成の例で見ていきます．先ほどと同じように，マネージメントコンソールでバケットを作り，また，Terraformのリソースとして設定していきます．

```terraform

```

## 検証を行う

さて，これをベースにリソースを作ってみます．バケット名は全世界で唯一ですのでバケット名だけ変えてリソースを作成して，マネージメントコンソールで見てみましょう．

このように，若干の際が発生してしまうのです．今回の場合，


これでおそらく同一のものができたと思われます（と言いながら自信がないのは他にも見落としがないか不安だからです）．
